********* QUERY **********
set search_path to app_siam_lds;
**************************

SET
********* QUERY **********
select prvcode from get_t05_card_pass_num order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ****************************取7-9月的排队数据*************************************
 \r
 %let startdate='2016-07-29';\r
 %let enddate='2016-9-30';\r
 \r
 *1.1 取卡号*
 \r
 %_eg_conditional_dropds(sasdb_gp.T05_Card_PASS_NUMtmpLZ);\r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
                 create table &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ as (\r
                 select distinct a.cst_ofrnum_dt as TX_DT, b.pass_num,'cardno' as remark\r
                         from &gpSchemaAQR0..T0162_CUST_QUEUE_INFO_A a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.srcsys_ar_id = b.card_no\r
                         and a.cst_ofrnum_dt >= &startdate. and a.cst_ofrnum_dt <= &enddate.);\r
                 )by gp_aqrdb;\r
 disconnect from gp_aqrdb;\r
 quit;\r
 *1.2 取身份证号*
 \r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
                 insert into &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ  (\r
                         select distinct a.cst_ofrnum_dt as TX_DT, substring(a.srcsys_ar_id from 3 for length(a.srcsys_ar_id) - 2) as pass_num,\r
                         'idcard' as remark\r
                         from &gpSchemaAQR0..T0162_CUST_QUEUE_INFO_A a\r
                         where substring(a.srcsys_ar_id from 1 for 2) = 'id'\r
                         and a.cst_ofrnum_dt >= &startdate. and a.cst_ofrnum_dt <= &enddate.)\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *2.新老系统数据结合*
 \r
 %_eg_conditional_dropds(sasdb_gp.T05_Card_PASS_NUM1609LZ);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ as (                     \r
 select distinct * from &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ\r
             union \r
                    select distinct * from &gpSchemaAQRTmp1..T05_Card_PASS_NUM   \r
                         )\r
         )by gp_aqrdb;   \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
(51 rows)

********* QUERY **********
select prvcode from get_rule_refine_detail order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let startdate='2016-07-01';\r
 %let enddate='2016-9-30';\r
 \r
 %let FCMARLDtmp=Tmp_FCMARLD;
 *提取重要非账务性流水表的时间、柜员号、交易描述*
 \r
 %let FCMARLDBrantmp=Tmp_FCMARLD_Bran;
 *提取重要非账务性流水表的网点号*
 \r
 %let FCMARLDDetail=Tmp_FCMARLD_BranID;
 *提取重要非账务性流水表的身份证、卡号*
 \r
 %let ATMDetail=Tmp_AtmDetail;
 *提取ATM的时间，卡号、身份证号、网点号*
 \r
 %let MainFlowDetail=Tmp_MainFlow;
 *提取签约主流水表客户号、身份证号、机构号、时间*
 \r
 %let TXEVENTtmp=Tmp3_TXEVENT;
 *提取活期存款明细档柜面交易的时间,卡号,网点号*
 \r
 %let TXEVENTDetail=Tmp3_TXEVENT_Abcd;
 *提取活期存款明细档柜面交易数据的身份证号*
 \r
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 \r
 *****************提取重要非账务性流水表的时间、柜员号、卡号、身份证号、交易描述、网点号*************
 \r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDtmp.);\r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDBrantmp.);\r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDDetail.);\r
 *提取时间、柜员号、交易描述*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDtmp. as (\r
                         select distinct a.cm_tx_dt as tx_dt,a.cm_teller_id as oper_code,a.cm_acct_no,a.cm_aply_data_dscrp_arl as aply_dscrp\r
 from &gpSchemaAQR0..TODDC_FCMARLD_A a\r
 where (a.cm_acct_no IS not NULL and a.cm_acct_no <> '')\r
                         and (a.cm_tx_dt >= &startdate. and a.cm_tx_dt <= &enddate.)\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 *提取网点号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDBrantmp. as (\r
                         select a.*,b.CM_OPUN_CODE as Branch_Id\r
                         from  &gpSchemaAQRTmp1..&FCMARLDtmp. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H  b\r
                                 on a.oper_code = b.CM_OPR_NO\r
                                and b.P9_END_DATE  = '2999-12-31')          \r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 *提取身份证、卡号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDDetail. as (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,a.cm_acct_no as card_no,b.pass_num,a.aply_dscrp,'card_no' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.card_no)\r
                 )by gp_aqrdb; \r
          execute(\r
                 insert into &gpSchemaAQRTmp1..&FCMARLDDetail. (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,b.card_no,a.cm_acct_no as pass_num,a.aply_dscrp,'pass_num' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.pass_num)\r
                 )by gp_aqrdb; \r
          execute(\r
                 insert into &gpSchemaAQRTmp1..&FCMARLDDetail. (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,b.card_no,a.cm_acct_no as pass_num,a.aply_dscrp,'cust_no' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.CUSTNO)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 ***************提取ATM的时间，卡号、身份证号、网点号*********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&ATMDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&ATMDetail. as (\r
                         select distinct a.*,b.pass_num\r
 from (select distinct k.CR_ENTR_DT as tx_dt,k.CR_CRD_NO as card_no,k.CR_TX_NETP_NO as Branch_ID,k.CR_CPU_DT \r
 from &gpSchemaAQR0..TODDC_CRATMDET_A k\r
                                   where (k.CR_ENTR_DT >= &startdate. and k.CR_ENTR_DT <= &enddate.)) a\r
                     inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                     on a.card_no =b.CARD_NO     \r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ***************提取签约主流水表客户号、身份证号、机构号、时间*********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&MainFlowDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&MainFlowDetail. as (\r
                         select distinct a.CUST_NO,a.CHANL_CUST_NO,a.CERT_ID,a.sign_bran as Branch_ID,a.p9_data_date,to_date(a.SIGN_DATE,'YYYYMMDD') as tx_dt,\r
                                (case when (a.CERT_ID IS not NULL and a.CERT_ID <> '') then a.CERT_ID else a.CHANL_CUST_NO end) as pass_num\r
 from &gpSchemaAQR0..TODEC_SIGN_MAIN_FLOW_A a\r
                         where (to_date(a.SIGN_DATE,'YYYYMMDD')>= &startdate. and to_date(a.SIGN_DATE,'YYYYMMDD')<= &enddate.)\r
                         and sign_bran <> '999999999'\r
                         and (a.sign_bran IS not NULL and a.sign_bran <> '')\r
 and ((a.CHANL_CUST_NO IS not NULL and a.CHANL_CUST_NO <> '')    \r
                          or (a.CERT_ID IS not NULL and a.CERT_ID <> '') )\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&MainFlowDetail.(\r
                         select distinct a.CUST_NO,a.CHANL_CUST_NO,a.CERT_ID,a.sign_bran as Branch_ID,a.p9_data_date,to_date(a.SIGN_DATE,'YYYYMMDD') as tx_dt,\r
                                (case when (a.CERT_ID IS not NULL and a.CERT_ID <> '') then a.CERT_ID else a.CHANL_CUST_NO end) as pass_num\r
 from &gpSchemaAQR0..T1000_SIGN_MAIN_FLOW_A a\r
                         where (to_date(a.SIGN_DATE,'YYYYMMDD')>= &startdate. and to_date(a.SIGN_DATE,'YYYYMMDD')<= &enddate.)\r
                         and sign_bran <> '999999999'\r
                         and (a.sign_bran IS not NULL and a.sign_bran <> '')\r
 and ((a.CHANL_CUST_NO IS not NULL and a.CHANL_CUST_NO <> '')    \r
                          or (a.CERT_ID IS not NULL and a.CERT_ID <> '') )\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ************************提取交易明细表柜面交易的时间,卡号,网点号,身份证号********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&TXEVENTtmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&TXEVENTtmp. as (\r
                         select distinct * \r
                         from &gpSchemaAQR0..TODDC_SAACNTXN_A \r
                                 where sa_tx_dt>=&startdate. and sa_tx_dt<=&enddate.\r
                                   and SA_DSCRP_COD in ('0045','0046','0047','6617','6620','6621','1104','1105','1106','1107','0127','0128','1537')\r
 )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&TXEVENTDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&TXEVENTDetail. as (\r
                         select distinct a.SA_TX_CRD_NO as trade_card,a.SA_TX_DT as tx_dt\r
 ,a.SA_OPUN_COD as branch_id,a.sa_dscrp_cod as abstract_cd,b.pass_num\r
                         from &gpSchemaAQRTmp1..&TXEVENTtmp. a\r
                         inner join  &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                            on a.SA_TX_CRD_NO = b.card_no\r
 )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 ****************结果细化数据准备表,汇总办理业务的时间、网点、身份证***************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Refine1Detail. as (                     \r
 select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&FCMARLDDetail.\r
             union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&ATMDetail.  \r
 union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&MainFlowDetail.\r
 union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&TXEVENTDetail.\r
                         )\r
         )by gp_aqrdb;   \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(194 rows)

********* QUERY **********
select prvcode from get_pbcs_rule1 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let startdate = '2016-10-01';\r
 %let enddate = '2016-09-30';\r
 %let tablename = T05_PBCS_EVENT_branch7_9;
 ***************CCBS综合前置的日志数据******************
 \r
 %let tablenameOPUN=T05_PBCS_EVENT_branch_opun7_9;
 ***************添加开户网点号************
 \r
 %let tablenameTmp=T05_PBCS_EVENT_branchSameTmp7_9;
 ****************匹配同地查询的********************
 \r
 %let tablenameNOsametmp=T05_PBCS_EVENT_branchNosame7_9;
 *************匹配异地查询的**************
 \r
 \r
 *******************************************异地无卡查询筛选**************************************
 \r
 * 1.1通过卡号补全身份证信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablename.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablename. as (\r
                         select distinct a.*, b.pass_num as Id_Crdt_No, b.card_no, 'cardno' as remark\r
                         from (select * from &gpSchemaAQR0..T05_PBCS_EVENT k \r
                                 where k.Tx_Dt  >= &startdate. and k.Tx_Dt  <= &enddate.\r
                                   and tx_code='00010501109600'\r
                                   and (Debit_Acct_Num IS NOT NULL and Debit_Acct_Num <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.Debit_Acct_Num = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 1.2当查询的卡号为空时,根据查询的身份证号获取所有卡号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&tablename. (\r
                         select distinct a.*,b.pass_num as Id_Crdt_No, b.card_no, 'idcard' as remark\r
                         from (select * from &gpSchemaAQR0..T05_PBCS_EVENT k \r
                                   where k.Tx_Dt >= &startdate. and k.Tx_Dt <= &enddate.\r
                                         and tx_code='00010501109600'\r
                                         and (Debit_Acct_Num IS  NULL or Debit_Acct_Num = '')\r
                                         and Debit_Customer_Num IS NOT NULL and Debit_Customer_Num <> '') a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on substr(a.Debit_Customer_Num,2,18) = b.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 * 2.根据银行卡主档获取营业单位代码CR_OPUN_COD --->注:这个比SIAM_CARD_INFO_H的开户行准确*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameOPUN.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameOPUN. as (\r
                         select a.*, b.CR_OPUN_COD\r
                         from &gpSchemaAQRTmp1..&tablename. a\r
                         inner join &gpSchemaAQR0..TODDC_CRCRDCRD_H b\r
                         on card_no = b.CR_CRD_NO);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.1匹配同地查询的信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameTmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameTmp. as (\r
                         select a.*,\r
                         (case when \r
                                 (substring(BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)) then 1 \r
                                 else 0 end) as same\r
                         from ( select distinct * from &gpSchemaAQRTmp1..&tablenameOPUN.) a\r
                         where  (a.BRANCH_ID IS Not null and a.BRANCH_ID <> ''))\r
                 )by gp_aqrdb;\r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.2卡号异地查询的明细 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.1);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
 create table &gpSchemaAQRTmp1..&tablenameNOsametmp.1 as (\r
 select distinct a.tx_dt as que_date,substr(a.Tx_Operator,6,12) as tlr_id,\r
 a.id_crdt_no as crdt_no,remark,sum(same) as is_same \r
 from &gpSchemaAQRTmp1..&tablenameTmp. a\r
                         group by a.tx_dt,substr(a.Tx_Operator,6,12),a.id_crdt_no,remark\r
                         having sum(same) = 0 \r
 and (a.Tx_Operator IS Not null and a.Tx_Operator <> ''));\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameNOsametmp. as (\r
                         select distinct a.que_date,a.tlr_id,b.branch_id as query_org,b.debit_acct_num,\r
 b.card_no,b.cr_opun_cod,b.debit_customer_num as cust_no,a.crdt_no\r
 from &gpSchemaAQRTmp1..&tablenameNOsametmp.1 a\r
                         inner join &gpSchemaAQRTmp1..&tablenameTmp. b\r
                           on a.que_date=b.tx_dt\r
 and a.tlr_id=substr(a.Tx_Operator,6,12) and a.crdt_no=b.id_crdt_no );\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 \r
 \r
 \r
 \r
(122 rows)

********* QUERY **********
select prvcode from get_pbcs_rule2 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoquene=PBCS_noquene7_9;
 *************不在排队机系统的日志信息*************
 \r
 \r
 \r
 * 获取客户未到的柜员查询信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoquene.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoquene. as (\r
                         select distinct a.tx_dt as que_date,substr(a.Tx_Operator,6,12) as tlr_id,\r
 a.branch_id as query_org,a.debit_customer_num as cust_no,a.debit_acct_num,a.card_no,\r
 a.id_crdt_no as crdt_no\r
                         from &gpSchemaAQRTmp1..&tablename. a\r
                         left join &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ b\r
                         on a.Tx_Dt =b.tx_dt\r
                         and a.Id_Crdt_No = b.PASS_NUM\r
                         where b.tx_dt IS NULL\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
(24 rows)

********* QUERY **********
select prvcode from get_pbcs_rule3 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoqueuenosame=PBCS_nosamenoqueue7_9;
 **********规则二与规则三的重合结果****************
 \r
 %let Rule23brannm=PBCS_Rule23brannm7_9;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let Rule23opernm=PBCS_Rule23opernm7_9;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let Rule23PbranNM=PBCS_Rule23PbranNM7_9;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 \r
 \r
 * 获取规则二与规则三的重合点 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosame. as (\r
                         select distinct a.* \r
                         from &gpSchemaAQRTMP1..&tablenameNOsametmp. a\r
                         inner join &gpSchemaAQRTMP1..&tablenoquene. b\r
                         on a.que_date = b.que_date\r
                         and a.tlr_id = b.tlr_id\r
                         and a.card_no = b.card_no);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 通过客户身份证号获取客户姓名信息 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23custnm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23custnm. as (\r
                         select distinct a.*,b.customer_name\r
                         from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                         inner join &gpSchemaAQR0..SIAM_CUST_INFO_H b\r
                         on a.crdt_no = b.pass_num and b.etl_end_date  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;*
 \r
 \r
 * 获取开户行机构名称 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23brannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23brannm. as (\r
 select distinct a.*,b.ccbins_chn_shrtnm as cr_opun_nm\r
                            from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                               inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                            on a.cr_opun_cod = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *添加柜员身份证号*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23operID.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23operID. as (\r
                    select distinct a.*,b.CM_id_NO\r
                         from  &gpSchemaAQRTMP1..&Rule23brannm. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                         on a.tlr_id=b.cm_opr_no and b.P9_END_DATE  = '2999-12-31'\r
 )\r
 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取员工名称，与员工所在网点号及网点名 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23opernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23opernm. as (\r
                         select a.*,b.CM_OPR_NAME,b.CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                            from &gpSchemaAQRTmp1..&Rule23operID. a\r
                            inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                               on tlr_id = b.CM_OPR_NO and b.P9_END_DATE  = '2999-12-31'\r
                        inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c\r
                               on b.CM_OPUN_CODE = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23PbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23PbranNM. as (\r
                         select distinct a.que_date,a.tlr_id,a.CM_id_NO,a.CM_OPR_NAME,a.query_org,a.CM_OPUN_CODE,\r
 a.ccbins_chn_shrtnm,b.parent_id,b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.debit_acct_num,\r
 a.card_no,a.cr_opun_cod,a.cr_opun_nm,a.cust_no,a.crdt_no\r
                         from &gpSchemaAQRTmp1..&Rule23opernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(111 rows)

********* QUERY **********
select prvcode from get_pbcs_rule4 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 %let Rule23refine1Detail=PBCS_Rule23_refine7_9;
 *获取规则二三结果中未在查询网点交易的数据*
 \r
 %let tablenoqueuenosameRtj=PBCS_Rule23tjR7_9;
 *对细化后数据统计查询量*
 \r
 %let tablenoqueuenosameRtjd=PBCS_Rule23tjdR7_9;
 *按日期统计细化数据*
 \r
 \r
 \r
 ****************************获取规则二三结果中未在查询网点交易的数据********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23refine1Detail. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQRTmp1..&Rule23PbranNM.  a\r
                         left join &gpSchemaAQRTmp1..&Refine1Detail. b\r
                         on a.que_date =b.tx_dt and a.crdt_no = b.PASS_NUM and a.query_org = b.branch_id\r
                         where b.tx_dt IS NULL \r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtj. as (\r
                    select a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtjd. as (\r
                         select a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(65 rows)

********* QUERY **********
select prvcode from get_ccbs_rule1 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ***************CCBS综合前置的日志数据:p2log_ccbs_res******************
 \r
 %let tablenameNOsametmp=ccbs_branch_notsame10_12;
 *************匹配异地查询的**************
 \r
 %let startdate = '2016-10-01';\r
 %let enddate = '2017-12-31';\r
 \r
 ******************************************************************************************
 \r
 * 通过卡号获取开卡机构 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.1 );\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameNOsametmp.1 as (\r
                         select distinct a.*,b.CARD_BRANCH\r
                         from (select distinct * from &gpSchemaAQR0..p2log_ccbs_res k \r
                                 where k.que_date >= &startdate. and k.que_date <= &enddate.\r
                                 and (card_no IS NOT NULL and card_no <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.card_no = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *********************找开户行CARD_BRANCH和查询行为异地的查询***************************
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.);\r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
         create table &gpSchemaAQRTmp1..&tablenameNOsametmp. as (\r
 select a.*\r
                 from ( select distinct * from &gpSchemaAQRTmp1..&tablenameNOsametmp.1) a\r
                 where substring(query_org from 1 for 3) <> substring(CARD_BRANCH from 1 for 3)\r
                         and que_date  >= &startdate.  and que_date  <=  &enddate.\r
                         and ((a.query_org IS Not null and a.query_org <> '')
 * 查询行为柜员所属支行*
 \r
                          or (a.CARD_BRANCH IS Not null and a.CARD_BRANCH <> ''))
 * 银行卡的开户行*
 \r
                         );\r
         )by gp_aqrdb;       \r
 disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&tablenameNOsametmp.;\r
 select min(que_date),max(que_date) from sasdb_gp.&tablenameNOsametmp.;\r
 select * from sasdb_gp.&tablenameNOsametmp.(obs=100);\r
 quit;\r
 \r
(55 rows)

********* QUERY **********
select prvcode from get_ccbs_rule2 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoquene=ccbs_noquene10_12;
 *************不在排队机系统的日志信息*************
 \r
 \r
 * 获取客户未到的柜员查询信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoquene.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoquene. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQR0..p2log_ccbs_res a\r
                         left join &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ b\r
                         on a.que_date =b.tx_dt\r
                         and a.crdt_no = b.PASS_NUM\r
                         where b.tx_dt IS NULL\r
                         and a.que_date  >= &startdate.  and a.que_date  <=  &enddate.\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&tablenoquene.;\r
 select min(que_date),max(que_date) from sasdb_gp.&tablenoquene.;\r
 select * from sasdb_gp.&tablenoquene.(obs=100);\r
 quit;
(28 rows)

********* QUERY **********
select prvcode from get_ccbs_rule3 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoqueuenosame=ccbs_nosamenoqueue10_12;
 **********规则二与规则三的重合结果****************
 \r
 %let Rule23brannm=ccbs_Rule23brannm10_12;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let Rule23operID=ccbs_Rule23operID10_12;
 **********对重合结果添加员工身份证********
 \r
 %let Rule23opernm=ccbs_Rule23opernm10_12;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let Rule23PbranNM=ccbs_Rule23PbranNM10_12;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 \r
 ***************** 获取规则二与规则三的重合点 ********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosame. as (\r
                         select distinct a.* \r
                         from &gpSchemaAQRTMP1..&tablenameNOsametmp. a\r
                         inner join &gpSchemaAQRTMP1..&tablenoquene. b\r
                         on a.que_date = b.que_date\r
                         and a.tlr_id = b.tlr_id\r
                         and a.card_no = b.card_no);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取客户卡开户行机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23brannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23brannm. as (\r
                         select distinct a.*,b.ccbins_chn_shrtnm as app_nm\r
                         from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                         on a.CARD_BRANCH = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 *添加柜员身份证号*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23operID.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23operID. as (\r
                    select distinct a.*,b.CM_id_NO\r
                         from  &gpSchemaAQRTMP1..&Rule23brannm. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                         on a.tlr_id=b.cm_opr_no and b.P9_END_DATE  = '2999-12-31'\r
 )\r
 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取员工名称与员工所在机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23opernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23opernm. as (\r
                         select a.*,b.CM_OPR_NAME,b.CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                         from &gpSchemaAQRTmp1..&Rule23operID. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b     \r
                         on a.tlr_id = b.CM_OPR_NO and b.P9_END_DATE  = '2999-12-31'\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c \r
                         on b.CM_OPUN_CODE = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23PbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23PbranNM. as (\r
                 select a.que_date,a.que_time,a.tlr_id,a.CM_id_NO,a.CM_OPR_NAME,a.query_org,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,b.parent_id,\r
 b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.card_no,a.CARD_BRANCH,a.app_nm,a.cust_no,a.crdt_no\r
                         from &gpSchemaAQRTmp1..&Rule23opernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&Rule23PbranNM.;\r
 select min(que_date),max(que_date) from sasdb_gp.&Rule23PbranNM.;\r
 select * from sasdb_gp.&Rule23PbranNM.(obs=100);\r
 quit;\r
 \r
 \r
 * 验证是否倾斜 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         select * from connection to gp_aqrdb(\r
                  select gp_segment_id,count(*) from &gpSchemaAQRTmp1..&Rule23PbranNM.\r
                 Group by 1\r
                 order by count(*) desc;\r
         );\r
         disconnect from gp_aqrdb;\r
 quit;\r
 * 重新分布 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 alter table &gpSchemaAQRTmp1..&Rule23PbranNM.\r
                 set with (reorganize=TRUE) distributed RANDOMLY;\r
         ) by gp_aqrdb;\r
 \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 \r
 \r
(131 rows)

********* QUERY **********
select prvcode from get_ccbs_rule4 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 %let Rule23refine1Detail=ccbs_Rule23_refine10_12;
 *获取规则二三结果中未在查询网点交易的数据*
 \r
 %let tablenoqueuenosameRtj=ccbs_Rule23tjR10_12;
 *对细化后数据统计查询量*
 \r
 %let tablenoqueuenosameRtjd=ccbs_Rule23tjdR10_12;
 *按日期统计细化数据*
 \r
 \r
 ****************************获取规则二三结果中未在查询网点交易的数据********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23refine1Detail. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQRTmp1..&Rule23PbranNM.  a\r
                         left join &gpSchemaAQRTmp1..&Refine1Detail. b\r
                         on a.que_date =b.tx_dt and a.crdt_no = b.PASS_NUM and a.query_org = b.branch_id\r
                         where b.tx_dt IS NULL \r
 and a.que_date >= &startdate. and a.que_date <= &enddate.\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtj. as (\r
                    select a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtjd. as (\r
                         select a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *导出报告*
 \r
 proc sql;\r
         create table tmp1 as\r
         select distinct * \r
 from sasdb_gp.&Rule23refine1Detail.\r
         order by CM_id_NO desc,tlr_id desc,que_date desc,que_time desc;\r
 quit;\r
 proc export data=tmp1\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_柜员无卡异地查询明细.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 proc sql;\r
         create table tmp2 as\r
         select distinct * from sasdb_gp.&tablenoqueuenosameRtj.\r
         order by num desc;\r
 quit;\r
 proc export data=tmp2\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_统计柜员查询数量.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 \r
 proc sql;\r
         create table tmp3 as\r
         select distinct * from sasdb_gp.&tablenoqueuenosameRtjd.\r
         order by num desc,que_date desc;\r
 quit;\r
 proc export data=tmp3\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_按日统计柜员查询数量.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 \r
 \r
(110 rows)

********* QUERY **********
select prvcode from get_p2_rule_new order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *新规则描述：\r
 1.查询交易限制：tx_code=A00421502|A00421517|A00421538|A00421547\r
 2.无卡查询规则：\r
 1）customer_identity_no为空 且 customer_acctount_no为空 则为无卡查询 \r
 3) 填充客户身份证id_crdt_no字段、客户号CST_ID、卡号fs_acct_no字段，完善客户信息\r
 2）根据卡号添加开户行，筛选无卡异地查询\r
 4）添加其他信息并统计\r
 *
 \r
 \r
 %let startdate = '2016-11-01';\r
 %let enddate = '2016-11-30';\r
 %let p2nocard = T2000_p2log_nocard1125;
 * 找出无卡查询数据*
 \r
 %let IDtablename = p2log_identity1125;
 * 补全身份证信息与卡号等信息*
 \r
 %let IDtablenameOPUN=p2log_identity_bran1125;
 * 补全开卡机构信息*
 \r
 %let IDtablenameTmp=p2log_bran1125_sametmp;
 * 增加标记，判断卡与柜员的地域关系 *
 \r
 %let IDtablenameNOsame=p2log_bran1125_nosame;
 * 获取异地查询信息 *
 \r
 %let RuleIDbrannm=p2log_ruleIDbrannm1125;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let RuleIDopernm=p2log_ruleIDopernm1125;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let RuleIDPbranNM=p2log_ruleIDPbranNM1125;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 %let tablenocardnosame=p2log_ruleIDCoin1125;
 **********异地无卡查询明细****************
 \r
 %let tablenocardnosameRtj=p2log_ruleIDtjR1125;
 *对细化后数据统计查询量*
 \r
 %let tablenocardnosameRtjd=p2log_ruleIDtjdR1125;
 *按日期统计细化数据*
 \r
 \r
 ***********************************新规则**************************************
 \r
 *1.找出身份识别数据客户卡号和身份证号全部为空的数据,判断为无卡查询*
 \r
 %_eg_conditional_dropds(sasdb_gp.&p2nocard.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&p2nocard. as (\r
                 select distinct a.*\r
                         from &gpSchemaAQR0..p2log_cst_query a\r
                         where \r
 substring(a.tx_code from 1 for 9) in ('A00421502','A00421517','A00421538','A00421547')\r
 *(a.tx_code like 'A00421502%' or a.tx_code like 'A00421517%'\r
 or a.tx_code like 'A00421538%' or a.tx_code like 'A00421547%') *
 \r
                         and (a.tx_date >= &startdate. and a.tx_date <= &enddate.)\r
 and (a.customer_identity_no IS  NULL or a.customer_identity_no = '')\r
                         and (a.customer_acctount_no IS  NULL or a.customer_acctount_no = '')\r
                         )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.1通过卡号补全身份证信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablename.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablename. as (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,b.pass_num,a.FS_ACCT_NO,b.card_no,\r
 'cardno' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                                    where (k.FS_ACCT_NO IS NOT NULL and k.FS_ACCT_NO <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                            on a.FS_ACCT_NO = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.2根据身份证获取所有卡号,补全信息*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&IDtablename. (\r
 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,b.pass_num,a.FS_ACCT_NO,b.card_no,\r
 'idcard' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                                    where (k.FS_ACCT_NO IS  NULL or k.FS_ACCT_NO = '')\r
                                         and (k.Id_Crdt_No IS NOT NULL and k.Id_Crdt_No <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.Id_Crdt_No = b.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.3根据客户号获取卡号、身份证号,补全信息 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&IDtablename. (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,c.pass_num,a.FS_ACCT_NO,c.card_no,\r
 'custnum' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                           where (k.FS_ACCT_NO IS  NULL or k.FS_ACCT_NO = '')\r
                                 and (k.Id_Crdt_No IS  NULL or k.Id_Crdt_No = '')\r
                                 and k.Cst_ID IS NOT NULL and k.Cst_ID <> '') a\r
                         inner join &gpSchemaAQR0..T0042_TBPC1010_H b\r
                        on a.CST_ID = b.CST_ID\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H c\r
                            on b.CRDT_NO = c.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.根据银行卡主档获取营业单位代码CR_OPUN_COD --->注:这个比SIAM_CARD_INFO_H的开户行准确*
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameOPUN.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameOPUN. as (\r
                         select a.*, b.CR_OPUN_COD \r
                         from &gpSchemaAQRTmp1..&IDtablename. a\r
                         inner join &gpSchemaAQR0..TODDC_CRCRDCRD_H b\r
                         on card_no = b.CR_CRD_NO);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.1 匹配同地查询的信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameTmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameTmp. as (\r
                         select a.*,\r
                         (case when \r
                                 (substring(INST_LEVEL1_BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)\r
                                  or substring(BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)) then 1 \r
                                  else 0 end) as same\r
                              from (select distinct * from &gpSchemaAQRTmp1..&IDtablenameOPUN.) a\r
                         where (a.INST_LEVEL1_BRANCH_ID IS Not null and a.INST_LEVEL1_BRANCH_ID <> '')\r
                        or (a.BRANCH_ID IS Not null and a.BRANCH_ID <> '')) \r
                 )by gp_aqrdb;\r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.2 卡号异地查询的明细 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameNOsame.1);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameNOsame.1 as (\r
                         select distinct a.tx_date,a.tx_time,a.OPER_CODE,a.pass_num,remark,sum(same) as is_same \r
 from &gpSchemaAQRTmp1..&IDtablenameTmp. a\r
                         group by a.tx_date,a.tx_time,a.OPER_CODE,a.pass_num,remark\r
                         having sum(same) = 0 \r
 and (a.oper_code IS Not null and a.oper_code <> ''));\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameNOsame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameNOsame. as (\r
                         select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.card_no,a.CR_OPUN_COD\r
 from &gpSchemaAQRTmp1..&IDtablenameTmp. a\r
                         inner join &gpSchemaAQRTmp1..&IDtablenameNOsame.1 b\r
 on a.tx_date=b.tx_date and a.tx_time=b.tx_time \r
 and a.OPER_CODE=b.OPER_CODE and a.pass_num=b.pass_num)\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.1获取客户卡开户行机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDbrannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDbrannm. as (\r
                         select distinct a.*,b.ccbins_chn_shrtnm as CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&IDtablenameNOsame. a\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                       on a.CR_OPUN_COD = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.2 获取员工名称与员工所在机构号及网点名 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDopernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDopernm. as (\r
                         select distinct a.*,b.USR_NM as CM_OPR_NAME,b.BLNG_INSID as CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                         from &gpSchemaAQRTmp1..&RuleIDbrannm. a\r
                       inner join &gpSchemaAQR0..T0861_EMPE_H b\r
                              on OPER_CODE = b.CCB_EMPID and b.P9_END_DATE  = '2999-12-31'\r
                       inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c\r
                             on b.BLNG_INSID = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.3 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDPbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDPbranNM. as (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.CM_OPR_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,b.parent_id,\r
 b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.card_no,\r
 a.CR_OPUN_COD,a.CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&RuleIDopernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ***********************************统计**************************************
 \r
 *异地无卡查询明细*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosame. as (\r
                         select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.CM_OPR_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,a.parent_id,\r
 a.parent_chn_shrtnm,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.CR_OPUN_COD,a.CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&RuleIDPbranNM.  a\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
         select count(*) as tablenocardnosame from sasdb_gp.&tablenocardnosame.;\r
         select min(tx_date),max(tx_date) from sasdb_gp.&tablenocardnosame.;\r
         select * from sasdb_gp.&tablenocardnosame.(obs=100);\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosameRtj. as (\r
                    select a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.pass_num) as num\r
                         from  &gpSchemaAQRTMP1..&tablenocardnosame. a\r
                         group by a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosameRtjd. as (\r
                         select a.tx_date,a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.pass_num) as num\r
                         from  &gpSchemaAQRTMP1..&tablenocardnosame. a\r
                         group by a.tx_date,a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(299 rows)

********* QUERY **********
set search_path to app_siam_lds;
**************************

SET
********* QUERY **********
select prvcode from get_t05_card_pass_num order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ****************************取7-9月的排队数据*************************************
 \r
 %let startdate='2016-07-29';\r
 %let enddate='2016-9-30';\r
 \r
 *1.1 取卡号*
 \r
 %_eg_conditional_dropds(sasdb_gp.T05_Card_PASS_NUMtmpLZ);\r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
                 create table &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ as (\r
                 select distinct a.cst_ofrnum_dt as TX_DT, b.pass_num,'cardno' as remark\r
                         from &gpSchemaAQR0..T0162_CUST_QUEUE_INFO_A a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.srcsys_ar_id = b.card_no\r
                         and a.cst_ofrnum_dt >= &startdate. and a.cst_ofrnum_dt <= &enddate.);\r
                 )by gp_aqrdb;\r
 disconnect from gp_aqrdb;\r
 quit;\r
 *1.2 取身份证号*
 \r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
                 insert into &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ  (\r
                         select distinct a.cst_ofrnum_dt as TX_DT, substring(a.srcsys_ar_id from 3 for length(a.srcsys_ar_id) - 2) as pass_num,\r
                         'idcard' as remark\r
                         from &gpSchemaAQR0..T0162_CUST_QUEUE_INFO_A a\r
                         where substring(a.srcsys_ar_id from 1 for 2) = 'id'\r
                         and a.cst_ofrnum_dt >= &startdate. and a.cst_ofrnum_dt <= &enddate.)\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *2.新老系统数据结合*
 \r
 %_eg_conditional_dropds(sasdb_gp.T05_Card_PASS_NUM1609LZ);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ as (                     \r
 select distinct * from &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ\r
             union \r
                    select distinct * from &gpSchemaAQRTmp1..T05_Card_PASS_NUM   \r
                         )\r
         )by gp_aqrdb;   \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
(51 rows)

********* QUERY **********
select prvcode from get_rule_refine_detail order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let startdate='2016-07-01';\r
 %let enddate='2016-9-30';\r
 \r
 %let FCMARLDtmp=Tmp_FCMARLD;
 *提取重要非账务性流水表的时间、柜员号、交易描述*
 \r
 %let FCMARLDBrantmp=Tmp_FCMARLD_Bran;
 *提取重要非账务性流水表的网点号*
 \r
 %let FCMARLDDetail=Tmp_FCMARLD_BranID;
 *提取重要非账务性流水表的身份证、卡号*
 \r
 %let ATMDetail=Tmp_AtmDetail;
 *提取ATM的时间，卡号、身份证号、网点号*
 \r
 %let MainFlowDetail=Tmp_MainFlow;
 *提取签约主流水表客户号、身份证号、机构号、时间*
 \r
 %let TXEVENTtmp=Tmp3_TXEVENT;
 *提取活期存款明细档柜面交易的时间,卡号,网点号*
 \r
 %let TXEVENTDetail=Tmp3_TXEVENT_Abcd;
 *提取活期存款明细档柜面交易数据的身份证号*
 \r
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 \r
 *****************提取重要非账务性流水表的时间、柜员号、卡号、身份证号、交易描述、网点号*************
 \r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDtmp.);\r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDBrantmp.);\r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDDetail.);\r
 *提取时间、柜员号、交易描述*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDtmp. as (\r
                         select distinct a.cm_tx_dt as tx_dt,a.cm_teller_id as oper_code,a.cm_acct_no,a.cm_aply_data_dscrp_arl as aply_dscrp\r
 from &gpSchemaAQR0..TODDC_FCMARLD_A a\r
 where (a.cm_acct_no IS not NULL and a.cm_acct_no <> '')\r
                         and (a.cm_tx_dt >= &startdate. and a.cm_tx_dt <= &enddate.)\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 *提取网点号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDBrantmp. as (\r
                         select a.*,b.CM_OPUN_CODE as Branch_Id\r
                         from  &gpSchemaAQRTmp1..&FCMARLDtmp. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H  b\r
                                 on a.oper_code = b.CM_OPR_NO\r
                                and b.P9_END_DATE  = '2999-12-31')          \r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 *提取身份证、卡号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDDetail. as (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,a.cm_acct_no as card_no,b.pass_num,a.aply_dscrp,'card_no' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.card_no)\r
                 )by gp_aqrdb; \r
          execute(\r
                 insert into &gpSchemaAQRTmp1..&FCMARLDDetail. (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,b.card_no,a.cm_acct_no as pass_num,a.aply_dscrp,'pass_num' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.pass_num)\r
                 )by gp_aqrdb; \r
          execute(\r
                 insert into &gpSchemaAQRTmp1..&FCMARLDDetail. (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,b.card_no,a.cm_acct_no as pass_num,a.aply_dscrp,'cust_no' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.CUSTNO)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 ***************提取ATM的时间，卡号、身份证号、网点号*********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&ATMDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&ATMDetail. as (\r
                         select distinct a.*,b.pass_num\r
 from (select distinct k.CR_ENTR_DT as tx_dt,k.CR_CRD_NO as card_no,k.CR_TX_NETP_NO as Branch_ID,k.CR_CPU_DT \r
 from &gpSchemaAQR0..TODDC_CRATMDET_A k\r
                                   where (k.CR_ENTR_DT >= &startdate. and k.CR_ENTR_DT <= &enddate.)) a\r
                     inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                     on a.card_no =b.CARD_NO     \r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ***************提取签约主流水表客户号、身份证号、机构号、时间*********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&MainFlowDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&MainFlowDetail. as (\r
                         select distinct a.CUST_NO,a.CHANL_CUST_NO,a.CERT_ID,a.sign_bran as Branch_ID,a.p9_data_date,to_date(a.SIGN_DATE,'YYYYMMDD') as tx_dt,\r
                                (case when (a.CERT_ID IS not NULL and a.CERT_ID <> '') then a.CERT_ID else a.CHANL_CUST_NO end) as pass_num\r
 from &gpSchemaAQR0..TODEC_SIGN_MAIN_FLOW_A a\r
                         where (to_date(a.SIGN_DATE,'YYYYMMDD')>= &startdate. and to_date(a.SIGN_DATE,'YYYYMMDD')<= &enddate.)\r
                         and sign_bran <> '999999999'\r
                         and (a.sign_bran IS not NULL and a.sign_bran <> '')\r
 and ((a.CHANL_CUST_NO IS not NULL and a.CHANL_CUST_NO <> '')    \r
                          or (a.CERT_ID IS not NULL and a.CERT_ID <> '') )\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&MainFlowDetail.(\r
                         select distinct a.CUST_NO,a.CHANL_CUST_NO,a.CERT_ID,a.sign_bran as Branch_ID,a.p9_data_date,to_date(a.SIGN_DATE,'YYYYMMDD') as tx_dt,\r
                                (case when (a.CERT_ID IS not NULL and a.CERT_ID <> '') then a.CERT_ID else a.CHANL_CUST_NO end) as pass_num\r
 from &gpSchemaAQR0..T1000_SIGN_MAIN_FLOW_A a\r
                         where (to_date(a.SIGN_DATE,'YYYYMMDD')>= &startdate. and to_date(a.SIGN_DATE,'YYYYMMDD')<= &enddate.)\r
                         and sign_bran <> '999999999'\r
                         and (a.sign_bran IS not NULL and a.sign_bran <> '')\r
 and ((a.CHANL_CUST_NO IS not NULL and a.CHANL_CUST_NO <> '')    \r
                          or (a.CERT_ID IS not NULL and a.CERT_ID <> '') )\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ************************提取交易明细表柜面交易的时间,卡号,网点号,身份证号********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&TXEVENTtmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&TXEVENTtmp. as (\r
                         select distinct * \r
                         from &gpSchemaAQR0..TODDC_SAACNTXN_A \r
                                 where sa_tx_dt>=&startdate. and sa_tx_dt<=&enddate.\r
                                   and SA_DSCRP_COD in ('0045','0046','0047','6617','6620','6621','1104','1105','1106','1107','0127','0128','1537')\r
 )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&TXEVENTDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&TXEVENTDetail. as (\r
                         select distinct a.SA_TX_CRD_NO as trade_card,a.SA_TX_DT as tx_dt\r
 ,a.SA_OPUN_COD as branch_id,a.sa_dscrp_cod as abstract_cd,b.pass_num\r
                         from &gpSchemaAQRTmp1..&TXEVENTtmp. a\r
                         inner join  &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                            on a.SA_TX_CRD_NO = b.card_no\r
 )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 ****************结果细化数据准备表,汇总办理业务的时间、网点、身份证***************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Refine1Detail. as (                     \r
 select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&FCMARLDDetail.\r
             union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&ATMDetail.  \r
 union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&MainFlowDetail.\r
 union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&TXEVENTDetail.\r
                         )\r
         )by gp_aqrdb;   \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(194 rows)

********* QUERY **********
select prvcode from get_pbcs_rule1 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let startdate = '2016-10-01';\r
 %let enddate = '2016-09-30';\r
 %let tablename = T05_PBCS_EVENT_branch7_9;
 ***************CCBS综合前置的日志数据******************
 \r
 %let tablenameOPUN=T05_PBCS_EVENT_branch_opun7_9;
 ***************添加开户网点号************
 \r
 %let tablenameTmp=T05_PBCS_EVENT_branchSameTmp7_9;
 ****************匹配同地查询的********************
 \r
 %let tablenameNOsametmp=T05_PBCS_EVENT_branchNosame7_9;
 *************匹配异地查询的**************
 \r
 \r
 *******************************************异地无卡查询筛选**************************************
 \r
 * 1.1通过卡号补全身份证信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablename.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablename. as (\r
                         select distinct a.*, b.pass_num as Id_Crdt_No, b.card_no, 'cardno' as remark\r
                         from (select * from &gpSchemaAQR0..T05_PBCS_EVENT k \r
                                 where k.Tx_Dt  >= &startdate. and k.Tx_Dt  <= &enddate.\r
                                   and tx_code='00010501109600'\r
                                   and (Debit_Acct_Num IS NOT NULL and Debit_Acct_Num <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.Debit_Acct_Num = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 1.2当查询的卡号为空时,根据查询的身份证号获取所有卡号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&tablename. (\r
                         select distinct a.*,b.pass_num as Id_Crdt_No, b.card_no, 'idcard' as remark\r
                         from (select * from &gpSchemaAQR0..T05_PBCS_EVENT k \r
                                   where k.Tx_Dt >= &startdate. and k.Tx_Dt <= &enddate.\r
                                         and tx_code='00010501109600'\r
                                         and (Debit_Acct_Num IS  NULL or Debit_Acct_Num = '')\r
                                         and Debit_Customer_Num IS NOT NULL and Debit_Customer_Num <> '') a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on substr(a.Debit_Customer_Num,2,18) = b.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 * 2.根据银行卡主档获取营业单位代码CR_OPUN_COD --->注:这个比SIAM_CARD_INFO_H的开户行准确*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameOPUN.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameOPUN. as (\r
                         select a.*, b.CR_OPUN_COD\r
                         from &gpSchemaAQRTmp1..&tablename. a\r
                         inner join &gpSchemaAQR0..TODDC_CRCRDCRD_H b\r
                         on card_no = b.CR_CRD_NO);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.1匹配同地查询的信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameTmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameTmp. as (\r
                         select a.*,\r
                         (case when \r
                                 (substring(BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)) then 1 \r
                                 else 0 end) as same\r
                         from ( select distinct * from &gpSchemaAQRTmp1..&tablenameOPUN.) a\r
                         where  (a.BRANCH_ID IS Not null and a.BRANCH_ID <> ''))\r
                 )by gp_aqrdb;\r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.2卡号异地查询的明细 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.1);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
 create table &gpSchemaAQRTmp1..&tablenameNOsametmp.1 as (\r
 select distinct a.tx_dt as que_date,substr(a.Tx_Operator,6,12) as tlr_id,\r
 a.id_crdt_no as crdt_no,remark,sum(same) as is_same \r
 from &gpSchemaAQRTmp1..&tablenameTmp. a\r
                         group by a.tx_dt,substr(a.Tx_Operator,6,12),a.id_crdt_no,remark\r
                         having sum(same) = 0 \r
 and (a.Tx_Operator IS Not null and a.Tx_Operator <> ''));\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameNOsametmp. as (\r
                         select distinct a.que_date,a.tlr_id,b.branch_id as query_org,b.debit_acct_num,\r
 b.card_no,b.cr_opun_cod,b.debit_customer_num as cust_no,a.crdt_no\r
 from &gpSchemaAQRTmp1..&tablenameNOsametmp.1 a\r
                         inner join &gpSchemaAQRTmp1..&tablenameTmp. b\r
                           on a.que_date=b.tx_dt\r
 and a.tlr_id=substr(a.Tx_Operator,6,12) and a.crdt_no=b.id_crdt_no );\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 \r
 \r
 \r
 \r
(122 rows)

********* QUERY **********
select prvcode from get_pbcs_rule2 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoquene=PBCS_noquene7_9;
 *************不在排队机系统的日志信息*************
 \r
 \r
 \r
 * 获取客户未到的柜员查询信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoquene.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoquene. as (\r
                         select distinct a.tx_dt as que_date,substr(a.Tx_Operator,6,12) as tlr_id,\r
 a.branch_id as query_org,a.debit_customer_num as cust_no,a.debit_acct_num,a.card_no,\r
 a.id_crdt_no as crdt_no\r
                         from &gpSchemaAQRTmp1..&tablename. a\r
                         left join &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ b\r
                         on a.Tx_Dt =b.tx_dt\r
                         and a.Id_Crdt_No = b.PASS_NUM\r
                         where b.tx_dt IS NULL\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
(24 rows)

********* QUERY **********
select prvcode from get_pbcs_rule3 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoqueuenosame=PBCS_nosamenoqueue7_9;
 **********规则二与规则三的重合结果****************
 \r
 %let Rule23brannm=PBCS_Rule23brannm7_9;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let Rule23opernm=PBCS_Rule23opernm7_9;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let Rule23PbranNM=PBCS_Rule23PbranNM7_9;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 \r
 \r
 * 获取规则二与规则三的重合点 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosame. as (\r
                         select distinct a.* \r
                         from &gpSchemaAQRTMP1..&tablenameNOsametmp. a\r
                         inner join &gpSchemaAQRTMP1..&tablenoquene. b\r
                         on a.que_date = b.que_date\r
                         and a.tlr_id = b.tlr_id\r
                         and a.card_no = b.card_no);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 通过客户身份证号获取客户姓名信息 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23custnm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23custnm. as (\r
                         select distinct a.*,b.customer_name\r
                         from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                         inner join &gpSchemaAQR0..SIAM_CUST_INFO_H b\r
                         on a.crdt_no = b.pass_num and b.etl_end_date  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;*
 \r
 \r
 * 获取开户行机构名称 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23brannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23brannm. as (\r
 select distinct a.*,b.ccbins_chn_shrtnm as cr_opun_nm\r
                            from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                               inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                            on a.cr_opun_cod = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *添加柜员身份证号*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23operID.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23operID. as (\r
                    select distinct a.*,b.CM_id_NO\r
                         from  &gpSchemaAQRTMP1..&Rule23brannm. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                         on a.tlr_id=b.cm_opr_no and b.P9_END_DATE  = '2999-12-31'\r
 )\r
 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取员工名称，与员工所在网点号及网点名 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23opernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23opernm. as (\r
                         select a.*,b.CM_OPR_NAME,b.CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                            from &gpSchemaAQRTmp1..&Rule23operID. a\r
                            inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                               on tlr_id = b.CM_OPR_NO and b.P9_END_DATE  = '2999-12-31'\r
                        inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c\r
                               on b.CM_OPUN_CODE = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23PbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23PbranNM. as (\r
                         select distinct a.que_date,a.tlr_id,a.CM_id_NO,a.CM_OPR_NAME,a.query_org,a.CM_OPUN_CODE,\r
 a.ccbins_chn_shrtnm,b.parent_id,b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.debit_acct_num,\r
 a.card_no,a.cr_opun_cod,a.cr_opun_nm,a.cust_no,a.crdt_no\r
                         from &gpSchemaAQRTmp1..&Rule23opernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(111 rows)

********* QUERY **********
select prvcode from get_pbcs_rule4 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 %let Rule23refine1Detail=PBCS_Rule23_refine7_9;
 *获取规则二三结果中未在查询网点交易的数据*
 \r
 %let tablenoqueuenosameRtj=PBCS_Rule23tjR7_9;
 *对细化后数据统计查询量*
 \r
 %let tablenoqueuenosameRtjd=PBCS_Rule23tjdR7_9;
 *按日期统计细化数据*
 \r
 \r
 \r
 ****************************获取规则二三结果中未在查询网点交易的数据********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23refine1Detail. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQRTmp1..&Rule23PbranNM.  a\r
                         left join &gpSchemaAQRTmp1..&Refine1Detail. b\r
                         on a.que_date =b.tx_dt and a.crdt_no = b.PASS_NUM and a.query_org = b.branch_id\r
                         where b.tx_dt IS NULL \r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtj. as (\r
                    select a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtjd. as (\r
                         select a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(65 rows)

********* QUERY **********
select prvcode from get_ccbs_rule1 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ***************CCBS综合前置的日志数据:p2log_ccbs_res******************
 \r
 %let tablenameNOsametmp=ccbs_branch_notsame10_12;
 *************匹配异地查询的**************
 \r
 %let startdate = '2016-10-01';\r
 %let enddate = '2017-12-31';\r
 \r
 ******************************************************************************************
 \r
 * 通过卡号获取开卡机构 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.1 );\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameNOsametmp.1 as (\r
                         select distinct a.*,b.CARD_BRANCH\r
                         from (select distinct * from &gpSchemaAQR0..p2log_ccbs_res k \r
                                 where k.que_date >= &startdate. and k.que_date <= &enddate.\r
                                 and (card_no IS NOT NULL and card_no <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.card_no = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *********************找开户行CARD_BRANCH和查询行为异地的查询***************************
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.);\r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
         create table &gpSchemaAQRTmp1..&tablenameNOsametmp. as (\r
 select a.*\r
                 from ( select distinct * from &gpSchemaAQRTmp1..&tablenameNOsametmp.1) a\r
                 where substring(query_org from 1 for 3) <> substring(CARD_BRANCH from 1 for 3)\r
                         and que_date  >= &startdate.  and que_date  <=  &enddate.\r
                         and ((a.query_org IS Not null and a.query_org <> '')
 * 查询行为柜员所属支行*
 \r
                          or (a.CARD_BRANCH IS Not null and a.CARD_BRANCH <> ''))
 * 银行卡的开户行*
 \r
                         );\r
         )by gp_aqrdb;       \r
 disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&tablenameNOsametmp.;\r
 select min(que_date),max(que_date) from sasdb_gp.&tablenameNOsametmp.;\r
 select * from sasdb_gp.&tablenameNOsametmp.(obs=100);\r
 quit;\r
 \r
(55 rows)

********* QUERY **********
select prvcode from get_ccbs_rule2 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoquene=ccbs_noquene10_12;
 *************不在排队机系统的日志信息*************
 \r
 \r
 * 获取客户未到的柜员查询信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoquene.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoquene. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQR0..p2log_ccbs_res a\r
                         left join &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ b\r
                         on a.que_date =b.tx_dt\r
                         and a.crdt_no = b.PASS_NUM\r
                         where b.tx_dt IS NULL\r
                         and a.que_date  >= &startdate.  and a.que_date  <=  &enddate.\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&tablenoquene.;\r
 select min(que_date),max(que_date) from sasdb_gp.&tablenoquene.;\r
 select * from sasdb_gp.&tablenoquene.(obs=100);\r
 quit;
(28 rows)

********* QUERY **********
select prvcode from get_ccbs_rule3 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoqueuenosame=ccbs_nosamenoqueue10_12;
 **********规则二与规则三的重合结果****************
 \r
 %let Rule23brannm=ccbs_Rule23brannm10_12;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let Rule23operID=ccbs_Rule23operID10_12;
 **********对重合结果添加员工身份证********
 \r
 %let Rule23opernm=ccbs_Rule23opernm10_12;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let Rule23PbranNM=ccbs_Rule23PbranNM10_12;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 \r
 ***************** 获取规则二与规则三的重合点 ********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosame. as (\r
                         select distinct a.* \r
                         from &gpSchemaAQRTMP1..&tablenameNOsametmp. a\r
                         inner join &gpSchemaAQRTMP1..&tablenoquene. b\r
                         on a.que_date = b.que_date\r
                         and a.tlr_id = b.tlr_id\r
                         and a.card_no = b.card_no);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取客户卡开户行机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23brannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23brannm. as (\r
                         select distinct a.*,b.ccbins_chn_shrtnm as app_nm\r
                         from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                         on a.CARD_BRANCH = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 *添加柜员身份证号*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23operID.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23operID. as (\r
                    select distinct a.*,b.CM_id_NO\r
                         from  &gpSchemaAQRTMP1..&Rule23brannm. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                         on a.tlr_id=b.cm_opr_no and b.P9_END_DATE  = '2999-12-31'\r
 )\r
 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取员工名称与员工所在机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23opernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23opernm. as (\r
                         select a.*,b.CM_OPR_NAME,b.CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                         from &gpSchemaAQRTmp1..&Rule23operID. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b     \r
                         on a.tlr_id = b.CM_OPR_NO and b.P9_END_DATE  = '2999-12-31'\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c \r
                         on b.CM_OPUN_CODE = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23PbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23PbranNM. as (\r
                 select a.que_date,a.que_time,a.tlr_id,a.CM_id_NO,a.CM_OPR_NAME,a.query_org,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,b.parent_id,\r
 b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.card_no,a.CARD_BRANCH,a.app_nm,a.cust_no,a.crdt_no\r
                         from &gpSchemaAQRTmp1..&Rule23opernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&Rule23PbranNM.;\r
 select min(que_date),max(que_date) from sasdb_gp.&Rule23PbranNM.;\r
 select * from sasdb_gp.&Rule23PbranNM.(obs=100);\r
 quit;\r
 \r
 \r
 * 验证是否倾斜 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         select * from connection to gp_aqrdb(\r
                  select gp_segment_id,count(*) from &gpSchemaAQRTmp1..&Rule23PbranNM.\r
                 Group by 1\r
                 order by count(*) desc;\r
         );\r
         disconnect from gp_aqrdb;\r
 quit;\r
 * 重新分布 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 alter table &gpSchemaAQRTmp1..&Rule23PbranNM.\r
                 set with (reorganize=TRUE) distributed RANDOMLY;\r
         ) by gp_aqrdb;\r
 \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 \r
 \r
(131 rows)

********* QUERY **********
select prvcode from get_ccbs_rule4 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 %let Rule23refine1Detail=ccbs_Rule23_refine10_12;
 *获取规则二三结果中未在查询网点交易的数据*
 \r
 %let tablenoqueuenosameRtj=ccbs_Rule23tjR10_12;
 *对细化后数据统计查询量*
 \r
 %let tablenoqueuenosameRtjd=ccbs_Rule23tjdR10_12;
 *按日期统计细化数据*
 \r
 \r
 ****************************获取规则二三结果中未在查询网点交易的数据********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23refine1Detail. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQRTmp1..&Rule23PbranNM.  a\r
                         left join &gpSchemaAQRTmp1..&Refine1Detail. b\r
                         on a.que_date =b.tx_dt and a.crdt_no = b.PASS_NUM and a.query_org = b.branch_id\r
                         where b.tx_dt IS NULL \r
 and a.que_date >= &startdate. and a.que_date <= &enddate.\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtj. as (\r
                    select a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtjd. as (\r
                         select a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *导出报告*
 \r
 proc sql;\r
         create table tmp1 as\r
         select distinct * \r
 from sasdb_gp.&Rule23refine1Detail.\r
         order by CM_id_NO desc,tlr_id desc,que_date desc,que_time desc;\r
 quit;\r
 proc export data=tmp1\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_柜员无卡异地查询明细.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 proc sql;\r
         create table tmp2 as\r
         select distinct * from sasdb_gp.&tablenoqueuenosameRtj.\r
         order by num desc;\r
 quit;\r
 proc export data=tmp2\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_统计柜员查询数量.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 \r
 proc sql;\r
         create table tmp3 as\r
         select distinct * from sasdb_gp.&tablenoqueuenosameRtjd.\r
         order by num desc,que_date desc;\r
 quit;\r
 proc export data=tmp3\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_按日统计柜员查询数量.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 \r
 \r
(110 rows)

********* QUERY **********
select prvcode from get_p2_rule_new order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *新规则描述：\r
 1.查询交易限制：tx_code=A00421502|A00421517|A00421538|A00421547\r
 2.无卡查询规则：\r
 1）customer_identity_no为空 且 customer_acctount_no为空 则为无卡查询 \r
 3) 填充客户身份证id_crdt_no字段、客户号CST_ID、卡号fs_acct_no字段，完善客户信息\r
 2）根据卡号添加开户行，筛选无卡异地查询\r
 4）添加其他信息并统计\r
 *
 \r
 \r
 %let startdate = '2016-11-01';\r
 %let enddate = '2016-11-30';\r
 %let p2nocard = T2000_p2log_nocard1125;
 * 找出无卡查询数据*
 \r
 %let IDtablename = p2log_identity1125;
 * 补全身份证信息与卡号等信息*
 \r
 %let IDtablenameOPUN=p2log_identity_bran1125;
 * 补全开卡机构信息*
 \r
 %let IDtablenameTmp=p2log_bran1125_sametmp;
 * 增加标记，判断卡与柜员的地域关系 *
 \r
 %let IDtablenameNOsame=p2log_bran1125_nosame;
 * 获取异地查询信息 *
 \r
 %let RuleIDbrannm=p2log_ruleIDbrannm1125;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let RuleIDopernm=p2log_ruleIDopernm1125;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let RuleIDPbranNM=p2log_ruleIDPbranNM1125;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 %let tablenocardnosame=p2log_ruleIDCoin1125;
 **********异地无卡查询明细****************
 \r
 %let tablenocardnosameRtj=p2log_ruleIDtjR1125;
 *对细化后数据统计查询量*
 \r
 %let tablenocardnosameRtjd=p2log_ruleIDtjdR1125;
 *按日期统计细化数据*
 \r
 \r
 ***********************************新规则**************************************
 \r
 *1.找出身份识别数据客户卡号和身份证号全部为空的数据,判断为无卡查询*
 \r
 %_eg_conditional_dropds(sasdb_gp.&p2nocard.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&p2nocard. as (\r
                 select distinct a.*\r
                         from &gpSchemaAQR0..p2log_cst_query a\r
                         where \r
 substring(a.tx_code from 1 for 9) in ('A00421502','A00421517','A00421538','A00421547')\r
 *(a.tx_code like 'A00421502%' or a.tx_code like 'A00421517%'\r
 or a.tx_code like 'A00421538%' or a.tx_code like 'A00421547%') *
 \r
                         and (a.tx_date >= &startdate. and a.tx_date <= &enddate.)\r
 and (a.customer_identity_no IS  NULL or a.customer_identity_no = '')\r
                         and (a.customer_acctount_no IS  NULL or a.customer_acctount_no = '')\r
                         )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.1通过卡号补全身份证信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablename.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablename. as (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,b.pass_num,a.FS_ACCT_NO,b.card_no,\r
 'cardno' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                                    where (k.FS_ACCT_NO IS NOT NULL and k.FS_ACCT_NO <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                            on a.FS_ACCT_NO = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.2根据身份证获取所有卡号,补全信息*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&IDtablename. (\r
 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,b.pass_num,a.FS_ACCT_NO,b.card_no,\r
 'idcard' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                                    where (k.FS_ACCT_NO IS  NULL or k.FS_ACCT_NO = '')\r
                                         and (k.Id_Crdt_No IS NOT NULL and k.Id_Crdt_No <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.Id_Crdt_No = b.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.3根据客户号获取卡号、身份证号,补全信息 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&IDtablename. (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,c.pass_num,a.FS_ACCT_NO,c.card_no,\r
 'custnum' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                           where (k.FS_ACCT_NO IS  NULL or k.FS_ACCT_NO = '')\r
                                 and (k.Id_Crdt_No IS  NULL or k.Id_Crdt_No = '')\r
                                 and k.Cst_ID IS NOT NULL and k.Cst_ID <> '') a\r
                         inner join &gpSchemaAQR0..T0042_TBPC1010_H b\r
                        on a.CST_ID = b.CST_ID\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H c\r
                            on b.CRDT_NO = c.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.根据银行卡主档获取营业单位代码CR_OPUN_COD --->注:这个比SIAM_CARD_INFO_H的开户行准确*
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameOPUN.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameOPUN. as (\r
                         select a.*, b.CR_OPUN_COD \r
                         from &gpSchemaAQRTmp1..&IDtablename. a\r
                         inner join &gpSchemaAQR0..TODDC_CRCRDCRD_H b\r
                         on card_no = b.CR_CRD_NO);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.1 匹配同地查询的信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameTmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameTmp. as (\r
                         select a.*,\r
                         (case when \r
                                 (substring(INST_LEVEL1_BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)\r
                                  or substring(BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)) then 1 \r
                                  else 0 end) as same\r
                              from (select distinct * from &gpSchemaAQRTmp1..&IDtablenameOPUN.) a\r
                         where (a.INST_LEVEL1_BRANCH_ID IS Not null and a.INST_LEVEL1_BRANCH_ID <> '')\r
                        or (a.BRANCH_ID IS Not null and a.BRANCH_ID <> '')) \r
                 )by gp_aqrdb;\r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.2 卡号异地查询的明细 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameNOsame.1);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameNOsame.1 as (\r
                         select distinct a.tx_date,a.tx_time,a.OPER_CODE,a.pass_num,remark,sum(same) as is_same \r
 from &gpSchemaAQRTmp1..&IDtablenameTmp. a\r
                         group by a.tx_date,a.tx_time,a.OPER_CODE,a.pass_num,remark\r
                         having sum(same) = 0 \r
 and (a.oper_code IS Not null and a.oper_code <> ''));\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameNOsame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameNOsame. as (\r
                         select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.card_no,a.CR_OPUN_COD\r
 from &gpSchemaAQRTmp1..&IDtablenameTmp. a\r
                         inner join &gpSchemaAQRTmp1..&IDtablenameNOsame.1 b\r
 on a.tx_date=b.tx_date and a.tx_time=b.tx_time \r
 and a.OPER_CODE=b.OPER_CODE and a.pass_num=b.pass_num)\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.1获取客户卡开户行机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDbrannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDbrannm. as (\r
                         select distinct a.*,b.ccbins_chn_shrtnm as CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&IDtablenameNOsame. a\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                       on a.CR_OPUN_COD = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.2 获取员工名称与员工所在机构号及网点名 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDopernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDopernm. as (\r
                         select distinct a.*,b.USR_NM as CM_OPR_NAME,b.BLNG_INSID as CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                         from &gpSchemaAQRTmp1..&RuleIDbrannm. a\r
                       inner join &gpSchemaAQR0..T0861_EMPE_H b\r
                              on OPER_CODE = b.CCB_EMPID and b.P9_END_DATE  = '2999-12-31'\r
                       inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c\r
                             on b.BLNG_INSID = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.3 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDPbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDPbranNM. as (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.CM_OPR_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,b.parent_id,\r
 b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.card_no,\r
 a.CR_OPUN_COD,a.CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&RuleIDopernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ***********************************统计**************************************
 \r
 *异地无卡查询明细*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosame. as (\r
                         select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.CM_OPR_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,a.parent_id,\r
 a.parent_chn_shrtnm,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.CR_OPUN_COD,a.CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&RuleIDPbranNM.  a\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
         select count(*) as tablenocardnosame from sasdb_gp.&tablenocardnosame.;\r
         select min(tx_date),max(tx_date) from sasdb_gp.&tablenocardnosame.;\r
         select * from sasdb_gp.&tablenocardnosame.(obs=100);\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosameRtj. as (\r
                    select a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.pass_num) as num\r
                         from  &gpSchemaAQRTMP1..&tablenocardnosame. a\r
                         group by a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosameRtjd. as (\r
                         select a.tx_date,a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.pass_num) as num\r
                         from  &gpSchemaAQRTMP1..&tablenocardnosame. a\r
                         group by a.tx_date,a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(299 rows)

********* QUERY **********
set search_path to app_siam_lds;
**************************

SET
********* QUERY **********
select prvcode from get_t05_card_pass_num order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ****************************取7-9月的排队数据*************************************
 \r
 %let startdate='2016-07-29';\r
 %let enddate='2016-9-30';\r
 \r
 *1.1 取卡号*
 \r
 %_eg_conditional_dropds(sasdb_gp.T05_Card_PASS_NUMtmpLZ);\r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
                 create table &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ as (\r
                 select distinct a.cst_ofrnum_dt as TX_DT, b.pass_num,'cardno' as remark\r
                         from &gpSchemaAQR0..T0162_CUST_QUEUE_INFO_A a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.srcsys_ar_id = b.card_no\r
                         and a.cst_ofrnum_dt >= &startdate. and a.cst_ofrnum_dt <= &enddate.);\r
                 )by gp_aqrdb;\r
 disconnect from gp_aqrdb;\r
 quit;\r
 *1.2 取身份证号*
 \r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
                 insert into &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ  (\r
                         select distinct a.cst_ofrnum_dt as TX_DT, substring(a.srcsys_ar_id from 3 for length(a.srcsys_ar_id) - 2) as pass_num,\r
                         'idcard' as remark\r
                         from &gpSchemaAQR0..T0162_CUST_QUEUE_INFO_A a\r
                         where substring(a.srcsys_ar_id from 1 for 2) = 'id'\r
                         and a.cst_ofrnum_dt >= &startdate. and a.cst_ofrnum_dt <= &enddate.)\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *2.新老系统数据结合*
 \r
 %_eg_conditional_dropds(sasdb_gp.T05_Card_PASS_NUM1609LZ);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ as (                     \r
 select distinct * from &gpSchemaAQRTmp1..T05_Card_PASS_NUMtmpLZ\r
             union \r
                    select distinct * from &gpSchemaAQRTmp1..T05_Card_PASS_NUM   \r
                         )\r
         )by gp_aqrdb;   \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
(51 rows)

********* QUERY **********
select prvcode from get_rule_refine_detail order by i;
**************************













                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let startdate='2016-07-01';\r
 %let enddate='2016-9-30';\r
 \r
 %let FCMARLDtmp=Tmp_FCMARLD;
 *提取重要非账务性流水表的时间、柜员号、交易描述*
 \r
 %let FCMARLDBrantmp=Tmp_FCMARLD_Bran;
 *提取重要非账务性流水表的网点号*
 \r
 %let FCMARLDDetail=Tmp_FCMARLD_BranID;
 *提取重要非账务性流水表的身份证、卡号*
 \r
 %let ATMDetail=Tmp_AtmDetail;
 *提取ATM的时间，卡号、身份证号、网点号*
 \r
 %let MainFlowDetail=Tmp_MainFlow;
 *提取签约主流水表客户号、身份证号、机构号、时间*
 \r
 %let TXEVENTtmp=Tmp3_TXEVENT;
 *提取活期存款明细档柜面交易的时间,卡号,网点号*
 \r
 %let TXEVENTDetail=Tmp3_TXEVENT_Abcd;
 *提取活期存款明细档柜面交易数据的身份证号*
 \r
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 \r
 *****************提取重要非账务性流水表的时间、柜员号、卡号、身份证号、交易描述、网点号*************
 \r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDtmp.);\r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDBrantmp.);\r
 %_eg_conditional_dropds(sasdb_gp.&FCMARLDDetail.);\r
 *提取时间、柜员号、交易描述*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDtmp. as (\r
                         select distinct a.cm_tx_dt as tx_dt,a.cm_teller_id as oper_code,a.cm_acct_no,a.cm_aply_data_dscrp_arl as aply_dscrp\r
 from &gpSchemaAQR0..TODDC_FCMARLD_A a\r
 where (a.cm_acct_no IS not NULL and a.cm_acct_no <> '')\r
                         and (a.cm_tx_dt >= &startdate. and a.cm_tx_dt <= &enddate.)\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 *提取网点号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDBrantmp. as (\r
                         select a.*,b.CM_OPUN_CODE as Branch_Id\r
                         from  &gpSchemaAQRTmp1..&FCMARLDtmp. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H  b\r
                                 on a.oper_code = b.CM_OPR_NO\r
                                and b.P9_END_DATE  = '2999-12-31')          \r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 *提取身份证、卡号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&FCMARLDDetail. as (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,a.cm_acct_no as card_no,b.pass_num,a.aply_dscrp,'card_no' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.card_no)\r
                 )by gp_aqrdb; \r
          execute(\r
                 insert into &gpSchemaAQRTmp1..&FCMARLDDetail. (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,b.card_no,a.cm_acct_no as pass_num,a.aply_dscrp,'pass_num' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.pass_num)\r
                 )by gp_aqrdb; \r
          execute(\r
                 insert into &gpSchemaAQRTmp1..&FCMARLDDetail. (\r
                         select distinct a.tx_dt,a.oper_code,a.Branch_Id,b.card_no,a.cm_acct_no as pass_num,a.aply_dscrp,'cust_no' as remark\r
                         from &gpSchemaAQRTmp1..&FCMARLDBrantmp. a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                 on a.cm_acct_no = b.CUSTNO)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 ***************提取ATM的时间，卡号、身份证号、网点号*********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&ATMDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&ATMDetail. as (\r
                         select distinct a.*,b.pass_num\r
 from (select distinct k.CR_ENTR_DT as tx_dt,k.CR_CRD_NO as card_no,k.CR_TX_NETP_NO as Branch_ID,k.CR_CPU_DT \r
 from &gpSchemaAQR0..TODDC_CRATMDET_A k\r
                                   where (k.CR_ENTR_DT >= &startdate. and k.CR_ENTR_DT <= &enddate.)) a\r
                     inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                                     on a.card_no =b.CARD_NO     \r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ***************提取签约主流水表客户号、身份证号、机构号、时间*********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&MainFlowDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&MainFlowDetail. as (\r
                         select distinct a.CUST_NO,a.CHANL_CUST_NO,a.CERT_ID,a.sign_bran as Branch_ID,a.p9_data_date,to_date(a.SIGN_DATE,'YYYYMMDD') as tx_dt,\r
                                (case when (a.CERT_ID IS not NULL and a.CERT_ID <> '') then a.CERT_ID else a.CHANL_CUST_NO end) as pass_num\r
 from &gpSchemaAQR0..TODEC_SIGN_MAIN_FLOW_A a\r
                         where (to_date(a.SIGN_DATE,'YYYYMMDD')>= &startdate. and to_date(a.SIGN_DATE,'YYYYMMDD')<= &enddate.)\r
                         and sign_bran <> '999999999'\r
                         and (a.sign_bran IS not NULL and a.sign_bran <> '')\r
 and ((a.CHANL_CUST_NO IS not NULL and a.CHANL_CUST_NO <> '')    \r
                          or (a.CERT_ID IS not NULL and a.CERT_ID <> '') )\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&MainFlowDetail.(\r
                         select distinct a.CUST_NO,a.CHANL_CUST_NO,a.CERT_ID,a.sign_bran as Branch_ID,a.p9_data_date,to_date(a.SIGN_DATE,'YYYYMMDD') as tx_dt,\r
                                (case when (a.CERT_ID IS not NULL and a.CERT_ID <> '') then a.CERT_ID else a.CHANL_CUST_NO end) as pass_num\r
 from &gpSchemaAQR0..T1000_SIGN_MAIN_FLOW_A a\r
                         where (to_date(a.SIGN_DATE,'YYYYMMDD')>= &startdate. and to_date(a.SIGN_DATE,'YYYYMMDD')<= &enddate.)\r
                         and sign_bran <> '999999999'\r
                         and (a.sign_bran IS not NULL and a.sign_bran <> '')\r
 and ((a.CHANL_CUST_NO IS not NULL and a.CHANL_CUST_NO <> '')    \r
                          or (a.CERT_ID IS not NULL and a.CERT_ID <> '') )\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ************************提取交易明细表柜面交易的时间,卡号,网点号,身份证号********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&TXEVENTtmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&TXEVENTtmp. as (\r
                         select distinct * \r
                         from &gpSchemaAQR0..TODDC_SAACNTXN_A \r
                                 where sa_tx_dt>=&startdate. and sa_tx_dt<=&enddate.\r
                                   and SA_DSCRP_COD in ('0045','0046','0047','6617','6620','6621','1104','1105','1106','1107','0127','0128','1537')\r
 )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&TXEVENTDetail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&TXEVENTDetail. as (\r
                         select distinct a.SA_TX_CRD_NO as trade_card,a.SA_TX_DT as tx_dt\r
 ,a.SA_OPUN_COD as branch_id,a.sa_dscrp_cod as abstract_cd,b.pass_num\r
                         from &gpSchemaAQRTmp1..&TXEVENTtmp. a\r
                         inner join  &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                            on a.SA_TX_CRD_NO = b.card_no\r
 )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 ****************结果细化数据准备表,汇总办理业务的时间、网点、身份证***************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Refine1Detail. as (                     \r
 select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&FCMARLDDetail.\r
             union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&ATMDetail.  \r
 union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&MainFlowDetail.\r
 union \r
                    select distinct tx_dt,Branch_Id,pass_num from &gpSchemaAQRTmp1..&TXEVENTDetail.\r
                         )\r
         )by gp_aqrdb;   \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(194 rows)

********* QUERY **********
select prvcode from get_pbcs_rule1 order by i;
**************************






                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let startdate = '2016-10-01';\r
 %let enddate = '2016-09-30';\r
 %let tablename = T05_PBCS_EVENT_branch7_9;
 ***************CCBS综合前置的日志数据******************
 \r
 %let tablenameOPUN=T05_PBCS_EVENT_branch_opun7_9;
 ***************添加开户网点号************
 \r
 %let tablenameTmp=T05_PBCS_EVENT_branchSameTmp7_9;
 ****************匹配同地查询的********************
 \r
 %let tablenameNOsametmp=T05_PBCS_EVENT_branchNosame7_9;
 *************匹配异地查询的**************
 \r
 \r
 *******************************************异地无卡查询筛选**************************************
 \r
 * 1.1通过卡号补全身份证信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablename.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablename. as (\r
                         select distinct a.*, b.pass_num as Id_Crdt_No, b.card_no, 'cardno' as remark\r
                         from (select * from &gpSchemaAQR0..T05_PBCS_EVENT k \r
                                 where k.Tx_Dt  >= &startdate. and k.Tx_Dt  <= &enddate.\r
                                   and tx_code='00010501109600'\r
                                   and (Debit_Acct_Num IS NOT NULL and Debit_Acct_Num <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.Debit_Acct_Num = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 1.2当查询的卡号为空时,根据查询的身份证号获取所有卡号*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&tablename. (\r
                         select distinct a.*,b.pass_num as Id_Crdt_No, b.card_no, 'idcard' as remark\r
                         from (select * from &gpSchemaAQR0..T05_PBCS_EVENT k \r
                                   where k.Tx_Dt >= &startdate. and k.Tx_Dt <= &enddate.\r
                                         and tx_code='00010501109600'\r
                                         and (Debit_Acct_Num IS  NULL or Debit_Acct_Num = '')\r
                                         and Debit_Customer_Num IS NOT NULL and Debit_Customer_Num <> '') a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on substr(a.Debit_Customer_Num,2,18) = b.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 * 2.根据银行卡主档获取营业单位代码CR_OPUN_COD --->注:这个比SIAM_CARD_INFO_H的开户行准确*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameOPUN.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameOPUN. as (\r
                         select a.*, b.CR_OPUN_COD\r
                         from &gpSchemaAQRTmp1..&tablename. a\r
                         inner join &gpSchemaAQR0..TODDC_CRCRDCRD_H b\r
                         on card_no = b.CR_CRD_NO);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.1匹配同地查询的信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameTmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameTmp. as (\r
                         select a.*,\r
                         (case when \r
                                 (substring(BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)) then 1 \r
                                 else 0 end) as same\r
                         from ( select distinct * from &gpSchemaAQRTmp1..&tablenameOPUN.) a\r
                         where  (a.BRANCH_ID IS Not null and a.BRANCH_ID <> ''))\r
                 )by gp_aqrdb;\r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.2卡号异地查询的明细 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.1);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
 create table &gpSchemaAQRTmp1..&tablenameNOsametmp.1 as (\r
 select distinct a.tx_dt as que_date,substr(a.Tx_Operator,6,12) as tlr_id,\r
 a.id_crdt_no as crdt_no,remark,sum(same) as is_same \r
 from &gpSchemaAQRTmp1..&tablenameTmp. a\r
                         group by a.tx_dt,substr(a.Tx_Operator,6,12),a.id_crdt_no,remark\r
                         having sum(same) = 0 \r
 and (a.Tx_Operator IS Not null and a.Tx_Operator <> ''));\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameNOsametmp. as (\r
                         select distinct a.que_date,a.tlr_id,b.branch_id as query_org,b.debit_acct_num,\r
 b.card_no,b.cr_opun_cod,b.debit_customer_num as cust_no,a.crdt_no\r
 from &gpSchemaAQRTmp1..&tablenameNOsametmp.1 a\r
                         inner join &gpSchemaAQRTmp1..&tablenameTmp. b\r
                           on a.que_date=b.tx_dt\r
 and a.tlr_id=substr(a.Tx_Operator,6,12) and a.crdt_no=b.id_crdt_no );\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 \r
 \r
 \r
 \r
(122 rows)

********* QUERY **********
select prvcode from get_pbcs_rule2 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoquene=PBCS_noquene7_9;
 *************不在排队机系统的日志信息*************
 \r
 \r
 \r
 * 获取客户未到的柜员查询信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoquene.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoquene. as (\r
                         select distinct a.tx_dt as que_date,substr(a.Tx_Operator,6,12) as tlr_id,\r
 a.branch_id as query_org,a.debit_customer_num as cust_no,a.debit_acct_num,a.card_no,\r
 a.id_crdt_no as crdt_no\r
                         from &gpSchemaAQRTmp1..&tablename. a\r
                         left join &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ b\r
                         on a.Tx_Dt =b.tx_dt\r
                         and a.Id_Crdt_No = b.PASS_NUM\r
                         where b.tx_dt IS NULL\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
(24 rows)

********* QUERY **********
select prvcode from get_pbcs_rule3 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoqueuenosame=PBCS_nosamenoqueue7_9;
 **********规则二与规则三的重合结果****************
 \r
 %let Rule23brannm=PBCS_Rule23brannm7_9;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let Rule23opernm=PBCS_Rule23opernm7_9;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let Rule23PbranNM=PBCS_Rule23PbranNM7_9;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 \r
 \r
 * 获取规则二与规则三的重合点 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosame. as (\r
                         select distinct a.* \r
                         from &gpSchemaAQRTMP1..&tablenameNOsametmp. a\r
                         inner join &gpSchemaAQRTMP1..&tablenoquene. b\r
                         on a.que_date = b.que_date\r
                         and a.tlr_id = b.tlr_id\r
                         and a.card_no = b.card_no);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 通过客户身份证号获取客户姓名信息 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23custnm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23custnm. as (\r
                         select distinct a.*,b.customer_name\r
                         from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                         inner join &gpSchemaAQR0..SIAM_CUST_INFO_H b\r
                         on a.crdt_no = b.pass_num and b.etl_end_date  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;*
 \r
 \r
 * 获取开户行机构名称 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23brannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23brannm. as (\r
 select distinct a.*,b.ccbins_chn_shrtnm as cr_opun_nm\r
                            from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                               inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                            on a.cr_opun_cod = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *添加柜员身份证号*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23operID.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23operID. as (\r
                    select distinct a.*,b.CM_id_NO\r
                         from  &gpSchemaAQRTMP1..&Rule23brannm. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                         on a.tlr_id=b.cm_opr_no and b.P9_END_DATE  = '2999-12-31'\r
 )\r
 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取员工名称，与员工所在网点号及网点名 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23opernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23opernm. as (\r
                         select a.*,b.CM_OPR_NAME,b.CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                            from &gpSchemaAQRTmp1..&Rule23operID. a\r
                            inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                               on tlr_id = b.CM_OPR_NO and b.P9_END_DATE  = '2999-12-31'\r
                        inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c\r
                               on b.CM_OPUN_CODE = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23PbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23PbranNM. as (\r
                         select distinct a.que_date,a.tlr_id,a.CM_id_NO,a.CM_OPR_NAME,a.query_org,a.CM_OPUN_CODE,\r
 a.ccbins_chn_shrtnm,b.parent_id,b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.debit_acct_num,\r
 a.card_no,a.cr_opun_cod,a.cr_opun_nm,a.cust_no,a.crdt_no\r
                         from &gpSchemaAQRTmp1..&Rule23opernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(111 rows)

********* QUERY **********
select prvcode from get_pbcs_rule4 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 %let Rule23refine1Detail=PBCS_Rule23_refine7_9;
 *获取规则二三结果中未在查询网点交易的数据*
 \r
 %let tablenoqueuenosameRtj=PBCS_Rule23tjR7_9;
 *对细化后数据统计查询量*
 \r
 %let tablenoqueuenosameRtjd=PBCS_Rule23tjdR7_9;
 *按日期统计细化数据*
 \r
 \r
 \r
 ****************************获取规则二三结果中未在查询网点交易的数据********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23refine1Detail. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQRTmp1..&Rule23PbranNM.  a\r
                         left join &gpSchemaAQRTmp1..&Refine1Detail. b\r
                         on a.que_date =b.tx_dt and a.crdt_no = b.PASS_NUM and a.query_org = b.branch_id\r
                         where b.tx_dt IS NULL \r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtj. as (\r
                    select a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtjd. as (\r
                         select a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(65 rows)

********* QUERY **********
select prvcode from get_ccbs_rule1 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ***************CCBS综合前置的日志数据:p2log_ccbs_res******************
 \r
 %let tablenameNOsametmp=ccbs_branch_notsame10_12;
 *************匹配异地查询的**************
 \r
 %let startdate = '2016-10-01';\r
 %let enddate = '2017-12-31';\r
 \r
 ******************************************************************************************
 \r
 * 通过卡号获取开卡机构 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.1 );\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenameNOsametmp.1 as (\r
                         select distinct a.*,b.CARD_BRANCH\r
                         from (select distinct * from &gpSchemaAQR0..p2log_ccbs_res k \r
                                 where k.que_date >= &startdate. and k.que_date <= &enddate.\r
                                 and (card_no IS NOT NULL and card_no <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.card_no = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *********************找开户行CARD_BRANCH和查询行为异地的查询***************************
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenameNOsametmp.);\r
 proc sql;\r
 connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
 execute(\r
         create table &gpSchemaAQRTmp1..&tablenameNOsametmp. as (\r
 select a.*\r
                 from ( select distinct * from &gpSchemaAQRTmp1..&tablenameNOsametmp.1) a\r
                 where substring(query_org from 1 for 3) <> substring(CARD_BRANCH from 1 for 3)\r
                         and que_date  >= &startdate.  and que_date  <=  &enddate.\r
                         and ((a.query_org IS Not null and a.query_org <> '')
 * 查询行为柜员所属支行*
 \r
                          or (a.CARD_BRANCH IS Not null and a.CARD_BRANCH <> ''))
 * 银行卡的开户行*
 \r
                         );\r
         )by gp_aqrdb;       \r
 disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&tablenameNOsametmp.;\r
 select min(que_date),max(que_date) from sasdb_gp.&tablenameNOsametmp.;\r
 select * from sasdb_gp.&tablenameNOsametmp.(obs=100);\r
 quit;\r
 \r
(55 rows)

********* QUERY **********
select prvcode from get_ccbs_rule2 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoquene=ccbs_noquene10_12;
 *************不在排队机系统的日志信息*************
 \r
 \r
 * 获取客户未到的柜员查询信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoquene.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoquene. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQR0..p2log_ccbs_res a\r
                         left join &gpSchemaAQRTmp1..T05_Card_PASS_NUM1609LZ b\r
                         on a.que_date =b.tx_dt\r
                         and a.crdt_no = b.PASS_NUM\r
                         where b.tx_dt IS NULL\r
                         and a.que_date  >= &startdate.  and a.que_date  <=  &enddate.\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&tablenoquene.;\r
 select min(que_date),max(que_date) from sasdb_gp.&tablenoquene.;\r
 select * from sasdb_gp.&tablenoquene.(obs=100);\r
 quit;
(28 rows)

********* QUERY **********
select prvcode from get_ccbs_rule3 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let tablenoqueuenosame=ccbs_nosamenoqueue10_12;
 **********规则二与规则三的重合结果****************
 \r
 %let Rule23brannm=ccbs_Rule23brannm10_12;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let Rule23operID=ccbs_Rule23operID10_12;
 **********对重合结果添加员工身份证********
 \r
 %let Rule23opernm=ccbs_Rule23opernm10_12;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let Rule23PbranNM=ccbs_Rule23PbranNM10_12;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 \r
 ***************** 获取规则二与规则三的重合点 ********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosame. as (\r
                         select distinct a.* \r
                         from &gpSchemaAQRTMP1..&tablenameNOsametmp. a\r
                         inner join &gpSchemaAQRTMP1..&tablenoquene. b\r
                         on a.que_date = b.que_date\r
                         and a.tlr_id = b.tlr_id\r
                         and a.card_no = b.card_no);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取客户卡开户行机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23brannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23brannm. as (\r
                         select distinct a.*,b.ccbins_chn_shrtnm as app_nm\r
                         from &gpSchemaAQRTmp1..&tablenoqueuenosame. a\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                         on a.CARD_BRANCH = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 *添加柜员身份证号*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23operID.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23operID. as (\r
                    select distinct a.*,b.CM_id_NO\r
                         from  &gpSchemaAQRTMP1..&Rule23brannm. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b\r
                         on a.tlr_id=b.cm_opr_no and b.P9_END_DATE  = '2999-12-31'\r
 )\r
 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取员工名称与员工所在机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23opernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23opernm. as (\r
                         select a.*,b.CM_OPR_NAME,b.CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                         from &gpSchemaAQRTmp1..&Rule23operID. a\r
                         inner join &gpSchemaAQR0..TODDC_FCMTLR0_H b     \r
                         on a.tlr_id = b.CM_OPR_NO and b.P9_END_DATE  = '2999-12-31'\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c \r
                         on b.CM_OPUN_CODE = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23PbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23PbranNM. as (\r
                 select a.que_date,a.que_time,a.tlr_id,a.CM_id_NO,a.CM_OPR_NAME,a.query_org,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,b.parent_id,\r
 b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.card_no,a.CARD_BRANCH,a.app_nm,a.cust_no,a.crdt_no\r
                         from &gpSchemaAQRTmp1..&Rule23opernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
 select count(*) as tablenameNOsameBran from sasdb_gp.&Rule23PbranNM.;\r
 select min(que_date),max(que_date) from sasdb_gp.&Rule23PbranNM.;\r
 select * from sasdb_gp.&Rule23PbranNM.(obs=100);\r
 quit;\r
 \r
 \r
 * 验证是否倾斜 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         select * from connection to gp_aqrdb(\r
                  select gp_segment_id,count(*) from &gpSchemaAQRTmp1..&Rule23PbranNM.\r
                 Group by 1\r
                 order by count(*) desc;\r
         );\r
         disconnect from gp_aqrdb;\r
 quit;\r
 * 重新分布 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 alter table &gpSchemaAQRTmp1..&Rule23PbranNM.\r
                 set with (reorganize=TRUE) distributed RANDOMLY;\r
         ) by gp_aqrdb;\r
 \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 \r
 \r
 \r
(131 rows)

********* QUERY **********
select prvcode from get_ccbs_rule4 order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 %let Refine1Detail=Tmp_Rule_refine;
 *结果细化数据准备表,汇总办理业务的时间、网点、身份证*
 \r
 %let Rule23refine1Detail=ccbs_Rule23_refine10_12;
 *获取规则二三结果中未在查询网点交易的数据*
 \r
 %let tablenoqueuenosameRtj=ccbs_Rule23tjR10_12;
 *对细化后数据统计查询量*
 \r
 %let tablenoqueuenosameRtjd=ccbs_Rule23tjdR10_12;
 *按日期统计细化数据*
 \r
 \r
 ****************************获取规则二三结果中未在查询网点交易的数据********************
 \r
 %_eg_conditional_dropds(sasdb_gp.&Rule23refine1Detail.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&Rule23refine1Detail. as (\r
                         select distinct a.*\r
                         from &gpSchemaAQRTmp1..&Rule23PbranNM.  a\r
                         left join &gpSchemaAQRTmp1..&Refine1Detail. b\r
                         on a.que_date =b.tx_dt and a.crdt_no = b.PASS_NUM and a.query_org = b.branch_id\r
                         where b.tx_dt IS NULL \r
 and a.que_date >= &startdate. and a.que_date <= &enddate.\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtj. as (\r
                    select a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenoqueuenosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenoqueuenosameRtjd. as (\r
                         select a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.crdt_no) as num\r
                         from  &gpSchemaAQRTMP1..&Rule23refine1Detail. a\r
                         group by a.que_date,a.tlr_id,a.CM_id_NO,a.cm_opr_name,a.query_org,a.cm_opun_code,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *导出报告*
 \r
 proc sql;\r
         create table tmp1 as\r
         select distinct * \r
 from sasdb_gp.&Rule23refine1Detail.\r
         order by CM_id_NO desc,tlr_id desc,que_date desc,que_time desc;\r
 quit;\r
 proc export data=tmp1\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_柜员无卡异地查询明细.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 proc sql;\r
         create table tmp2 as\r
         select distinct * from sasdb_gp.&tablenoqueuenosameRtj.\r
         order by num desc;\r
 quit;\r
 proc export data=tmp2\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_统计柜员查询数量.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 \r
 proc sql;\r
         create table tmp3 as\r
         select distinct * from sasdb_gp.&tablenoqueuenosameRtjd.\r
         order by num desc,que_date desc;\r
 quit;\r
 proc export data=tmp3\r
 outfile="~
 report
 lizhao
 无卡查询规则细化
 综合前置规则细化_按日统计柜员查询数量.csv"    dbms=dlm replace ;\r
 delimiter=',';\r
 run;\r
 \r
 \r
(110 rows)

********* QUERY **********
select prvcode from get_p2_rule_new order by i;
**************************

                                                                                        prvcode                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *新规则描述：\r
 1.查询交易限制：tx_code=A00421502|A00421517|A00421538|A00421547\r
 2.无卡查询规则：\r
 1）customer_identity_no为空 且 customer_acctount_no为空 则为无卡查询 \r
 3) 填充客户身份证id_crdt_no字段、客户号CST_ID、卡号fs_acct_no字段，完善客户信息\r
 2）根据卡号添加开户行，筛选无卡异地查询\r
 4）添加其他信息并统计\r
 *
 \r
 \r
 %let startdate = '2016-11-01';\r
 %let enddate = '2016-11-30';\r
 %let p2nocard = T2000_p2log_nocard1125;
 * 找出无卡查询数据*
 \r
 %let IDtablename = p2log_identity1125;
 * 补全身份证信息与卡号等信息*
 \r
 %let IDtablenameOPUN=p2log_identity_bran1125;
 * 补全开卡机构信息*
 \r
 %let IDtablenameTmp=p2log_bran1125_sametmp;
 * 增加标记，判断卡与柜员的地域关系 *
 \r
 %let IDtablenameNOsame=p2log_bran1125_nosame;
 * 获取异地查询信息 *
 \r
 %let RuleIDbrannm=p2log_ruleIDbrannm1125;
 **********对重合结果添加客户卡的开户网点名**************
 \r
 %let RuleIDopernm=p2log_ruleIDopernm1125;
 **********对重合结果添加员工名称与员工所在网点名********
 \r
 %let RuleIDPbranNM=p2log_ruleIDPbranNM1125;
 **********对重合结果添加员工所在网点父机构信息*********
 \r
 %let tablenocardnosame=p2log_ruleIDCoin1125;
 **********异地无卡查询明细****************
 \r
 %let tablenocardnosameRtj=p2log_ruleIDtjR1125;
 *对细化后数据统计查询量*
 \r
 %let tablenocardnosameRtjd=p2log_ruleIDtjdR1125;
 *按日期统计细化数据*
 \r
 \r
 ***********************************新规则**************************************
 \r
 *1.找出身份识别数据客户卡号和身份证号全部为空的数据,判断为无卡查询*
 \r
 %_eg_conditional_dropds(sasdb_gp.&p2nocard.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&p2nocard. as (\r
                 select distinct a.*\r
                         from &gpSchemaAQR0..p2log_cst_query a\r
                         where \r
 substring(a.tx_code from 1 for 9) in ('A00421502','A00421517','A00421538','A00421547')\r
 *(a.tx_code like 'A00421502%' or a.tx_code like 'A00421517%'\r
 or a.tx_code like 'A00421538%' or a.tx_code like 'A00421547%') *
 \r
                         and (a.tx_date >= &startdate. and a.tx_date <= &enddate.)\r
 and (a.customer_identity_no IS  NULL or a.customer_identity_no = '')\r
                         and (a.customer_acctount_no IS  NULL or a.customer_acctount_no = '')\r
                         )\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.1通过卡号补全身份证信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablename.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablename. as (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,b.pass_num,a.FS_ACCT_NO,b.card_no,\r
 'cardno' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                                    where (k.FS_ACCT_NO IS NOT NULL and k.FS_ACCT_NO <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                            on a.FS_ACCT_NO = b.card_no)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.2根据身份证获取所有卡号,补全信息*
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&IDtablename. (\r
 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,b.pass_num,a.FS_ACCT_NO,b.card_no,\r
 'idcard' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                                    where (k.FS_ACCT_NO IS  NULL or k.FS_ACCT_NO = '')\r
                                         and (k.Id_Crdt_No IS NOT NULL and k.Id_Crdt_No <> '')) a\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H b\r
                         on a.Id_Crdt_No = b.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 2.3根据客户号获取卡号、身份证号,补全信息 *
 \r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 insert into &gpSchemaAQRTmp1..&IDtablename. (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,a.TERMINAL_IP,\r
 a.org_short_cname,a.inst_level1_branch_id,a.BRANCH_ID,a.CST_ID,c.pass_num,a.FS_ACCT_NO,c.card_no,\r
 'custnum' as remark\r
                         from (select distinct * from &gpSchemaAQRTmp1..&p2nocard. k \r
                           where (k.FS_ACCT_NO IS  NULL or k.FS_ACCT_NO = '')\r
                                 and (k.Id_Crdt_No IS  NULL or k.Id_Crdt_No = '')\r
                                 and k.Cst_ID IS NOT NULL and k.Cst_ID <> '') a\r
                         inner join &gpSchemaAQR0..T0042_TBPC1010_H b\r
                        on a.CST_ID = b.CST_ID\r
                         inner join &gpSchemaAQR0..SIAM_CARD_INFO_H c\r
                            on b.CRDT_NO = c.pass_num);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.根据银行卡主档获取营业单位代码CR_OPUN_COD --->注:这个比SIAM_CARD_INFO_H的开户行准确*
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameOPUN.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameOPUN. as (\r
                         select a.*, b.CR_OPUN_COD \r
                         from &gpSchemaAQRTmp1..&IDtablename. a\r
                         inner join &gpSchemaAQR0..TODDC_CRCRDCRD_H b\r
                         on card_no = b.CR_CRD_NO);\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.1 匹配同地查询的信息 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameTmp.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameTmp. as (\r
                         select a.*,\r
                         (case when \r
                                 (substring(INST_LEVEL1_BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)\r
                                  or substring(BRANCH_ID from 1 for 3) = substring(CR_OPUN_COD from 1 for 3)) then 1 \r
                                  else 0 end) as same\r
                              from (select distinct * from &gpSchemaAQRTmp1..&IDtablenameOPUN.) a\r
                         where (a.INST_LEVEL1_BRANCH_ID IS Not null and a.INST_LEVEL1_BRANCH_ID <> '')\r
                        or (a.BRANCH_ID IS Not null and a.BRANCH_ID <> '')) \r
                 )by gp_aqrdb;\r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 3.2 卡号异地查询的明细 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameNOsame.1);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameNOsame.1 as (\r
                         select distinct a.tx_date,a.tx_time,a.OPER_CODE,a.pass_num,remark,sum(same) as is_same \r
 from &gpSchemaAQRTmp1..&IDtablenameTmp. a\r
                         group by a.tx_date,a.tx_time,a.OPER_CODE,a.pass_num,remark\r
                         having sum(same) = 0 \r
 and (a.oper_code IS Not null and a.oper_code <> ''));\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 %_eg_conditional_dropds(sasdb_gp.&IDtablenameNOsame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&IDtablenameNOsame. as (\r
                         select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.OPER_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.card_no,a.CR_OPUN_COD\r
 from &gpSchemaAQRTmp1..&IDtablenameTmp. a\r
                         inner join &gpSchemaAQRTmp1..&IDtablenameNOsame.1 b\r
 on a.tx_date=b.tx_date and a.tx_time=b.tx_time \r
 and a.OPER_CODE=b.OPER_CODE and a.pass_num=b.pass_num)\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.1获取客户卡开户行机构名称*
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDbrannm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDbrannm. as (\r
                         select distinct a.*,b.ccbins_chn_shrtnm as CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&IDtablenameNOsame. a\r
                         inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H b\r
                       on a.CR_OPUN_COD = b.ccbins_id and b.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.2 获取员工名称与员工所在机构号及网点名 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDopernm.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDopernm. as (\r
                         select distinct a.*,b.USR_NM as CM_OPR_NAME,b.BLNG_INSID as CM_OPUN_CODE,c.ccbins_chn_shrtnm\r
                         from &gpSchemaAQRTmp1..&RuleIDbrannm. a\r
                       inner join &gpSchemaAQR0..T0861_EMPE_H b\r
                              on OPER_CODE = b.CCB_EMPID and b.P9_END_DATE  = '2999-12-31'\r
                       inner join  &gpSchemaAQR0..T0651_CCBINS_INF_H c\r
                             on b.BLNG_INSID = c.ccbins_id and c.P9_END_DATE  = '2999-12-31')\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 * 4.3 获取父机构号 *
 \r
 %_eg_conditional_dropds(sasdb_gp.&RuleIDPbranNM.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&RuleIDPbranNM. as (\r
                 select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.CM_OPR_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,b.parent_id,\r
 b.ccbins_chn_shrtnm as parent_chn_shrtnm,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.card_no,\r
 a.CR_OPUN_COD,a.CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&RuleIDopernm. a\r
                         inner join &gpSchemaAQR0..ccbins_provice b\r
                         on a.CM_OPUN_CODE = b.scdy_ccbins_id)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 ***********************************统计**************************************
 \r
 *异地无卡查询明细*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosame.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosame. as (\r
                         select distinct a.tx_date,a.tx_time,a.tx_code,a.OPER_CODE,a.CM_OPR_NAME,a.TERMINAL_MAC,\r
 a.TERMINAL_IP,a.org_short_cname,a.BRANCH_ID,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,a.parent_id,\r
 a.parent_chn_shrtnm,a.CST_ID,a.pass_num,a.FS_ACCT_NO,a.CR_OPUN_COD,a.CR_OPUN_NM\r
                         from &gpSchemaAQRTmp1..&RuleIDPbranNM.  a\r
                         )\r
         )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 proc sql;\r
         select count(*) as tablenocardnosame from sasdb_gp.&tablenocardnosame.;\r
         select min(tx_date),max(tx_date) from sasdb_gp.&tablenocardnosame.;\r
         select * from sasdb_gp.&tablenocardnosame.(obs=100);\r
 quit;\r
 \r
 *统计查询量*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosameRtj.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosameRtj. as (\r
                    select a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.pass_num) as num\r
                         from  &gpSchemaAQRTMP1..&tablenocardnosame. a\r
                         group by a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                         order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
 *按日期统计*
 \r
 %_eg_conditional_dropds(sasdb_gp.&tablenocardnosameRtjd.);\r
 proc sql;\r
         connect to greenplm as gp_aqrdb(server=&gpServerAQR. database=&gpDatabaseAQR. port=&gpPortAQR. schema=&gpSchemaAQRTmp1. user=&gpUserAQRTmp1. password=&gpPasswordAQRTmp1.);\r
         execute(\r
                 create table &gpSchemaAQRTmp1..&tablenocardnosameRtjd. as (\r
                         select a.tx_date,a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm,count(distinct a.pass_num) as num\r
                         from  &gpSchemaAQRTMP1..&tablenocardnosame. a\r
                         group by a.tx_date,a.OPER_CODE,a.CM_OPR_NAME,a.CM_OPUN_CODE,a.ccbins_chn_shrtnm,\r
 a.parent_id,a.parent_chn_shrtnm\r
                    order by num desc)\r
                 )by gp_aqrdb; \r
         disconnect from gp_aqrdb;\r
 quit;\r
 \r
(299 rows)

